#!/bin/bash

# This hook will check for byte-compiler warnings any elisp files to be
# committed. The hook should exit with non-zero status after issuing an
# appropriate message to the user asking wether to ignore the warnings or
# not.

MODIFIED_FILES=$(git diff --name-only --cached)
ERRORS=0
for file in ${MODIFIED_FILES}; do
  IS_ELISP=$(file "$file" | grep "Lisp/Scheme program")
  if [[ $IS_ELISP != "" ]]; then
    EMACS=$(command -v emacs)
    if [[ $EMACS != "" ]]; then
      # emacs will exit with non-zero on errors but will still emit
      # warnings to stdout - we only want to block the commit if there are
      # actual errors since the byte-compiler is quite noisy
      $EMACS -q --batch --directory "$(dirname "$file")" -f batch-byte-compile "$file"
      ERRORS=$((ERRORS + $?))
      # remove the compiled elc file afterwards
      rm -f "${file}c"
    fi
  fi
done

if [[ $ERRORS -gt 0 ]]; then
  read -r -p 'Found emacs errors. Enter "ignore" to continue or anything else to exit: ' answer < /dev/tty
  if [ "${answer}" != "ignore" ]; then
    exit 1
  fi
fi

